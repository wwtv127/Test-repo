<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stellar Jump</title>
    
    <!-- Paho MQTT (Networking) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <!-- Tone.js (Sound) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        :root {
            --bg: #0b0c15;
            --board: #131520;
            --cell-border: rgba(255, 255, 255, 0.05);
            --accent: #00f2ff;
            --danger: #ff0055;
            --text: #e0e0e0;
            --p1: #00f2ff; --p2: #ff0055; --p3: #ffe600; --p4: #aa00ff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* --- UI LAYER --- */
        .screen {
            width: 100%;
            max-width: 480px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(0.95); position: absolute; z-index: -1; }

        h1 { margin: 0 0 10px 0; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; font-size: 2rem; text-shadow: 0 0 20px rgba(0,242,255,0.3); }
        .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- CONTROLS --- */
        input {
            background: #1a1c29; border: 1px solid #333; color: white;
            font-size: 2.5rem; text-align: center; padding: 15px;
            border-radius: 16px; width: 100%; margin-bottom: 20px;
            outline: none; font-weight: bold; letter-spacing: 8px;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--accent); }

        .btn-col { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        
        button {
            width: 100%; padding: 18px; border-radius: 14px; border: none;
            font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: all 0.1s; position: relative; overflow: hidden;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: white; color: black; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .btn-secondary { background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1); }

        /* --- BOARD CONTAINER --- */
        #game-area { width: 100%; max-width: 480px; aspect-ratio: 1/1; position: relative; margin-bottom: 20px; }
        
        #board {
            width: 100%; height: 100%;
            background: var(--board);
            border-radius: 4px;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        .cell {
            border: 1px solid var(--cell-border);
            display: flex; justify-content: center; align-items: center;
            font-size: 8px; color: rgba(255,255,255,0.15);
            position: relative;
        }
        
        /* Start/End Markers */
        .cell[data-id="1"] { background: rgba(0,255,0,0.05); color: #00ff00; font-weight: bold; }
        .cell[data-id="100"] { background: rgba(255,215,0,0.05); color: gold; font-weight: bold; }

        /* --- HOLES --- */
        .portal { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        
        /* White Hole (Ladder) Visuals */
        .wh-visual {
            position: absolute; width: 60%; height: 60%; top: 20%; left: 20%;
            border-radius: 50%; border: 1px solid var(--accent);
            box-shadow: 0 0 10px var(--accent), inset 0 0 10px var(--accent);
            opacity: 0.5; animation: pulse 2s infinite;
        }
        
        /* Black Hole (Snake) Visuals */
        .bh-visual {
            position: absolute; width: 80%; height: 80%; top: 10%; left: 10%;
            border-radius: 50%; background: radial-gradient(circle, #000 30%, var(--danger) 100%);
            opacity: 0.8; animation: spin 10s linear infinite;
        }

        @keyframes pulse { 0%,100% { transform: scale(0.8); opacity: 0.3; } 50% { transform: scale(1); opacity: 0.6; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- PLAYERS --- */
        .player-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        .token {
            width: 3.5%; /* Small size relative to board width */
            height: 3.5%;
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            box-shadow: 0 0 5px currentColor;
            background: currentColor;
            border: 1px solid white;
            transition: bottom 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Halo effect for active player */
        .token.active { box-shadow: 0 0 15px currentColor, 0 0 30px currentColor; z-index: 101; transform: scale(1.2); }

        /* --- HUD --- */
        #hud {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 480px;
            background: #1a1c29; padding: 15px 20px; border-radius: 16px;
            box-sizing: border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #turn-info { display: flex; flex-direction: column; }
        #turn-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        #turn-player { font-size: 1.1rem; font-weight: bold; color: white; }
        
        #dice-box { font-size: 2rem; width: 50px; text-align: center; }

        #roll-btn { 
            width: auto; padding: 12px 24px; background: var(--text); color: black;
            font-size: 0.9rem; opacity: 1; transition: opacity 0.2s;
        }
        #roll-btn:disabled { opacity: 0.2; cursor: default; background: #555; color: #888; }

        /* Log */
        #log { position: fixed; bottom: 10px; font-size: 0.7rem; color: #444; font-family: monospace; }
        #error-msg { color: var(--danger); font-size: 0.8rem; margin-top: 10px; min-height: 1.2rem; }

    </style>
</head>
<body>

    <!-- 1. START SCREEN -->
    <div id="screen-start" class="screen">
        <h1>Stellar Jump</h1>
        <p class="subtitle">Multiplayer Gravity Race</p>
        
        <div class="btn-col">
            <button class="btn-primary" onclick="initGame('create')">Create Universe</button>
            <button class="btn-secondary" onclick="nav('join')">Join Universe</button>
        </div>
        <div id="log"></div>
    </div>

    <!-- 2. JOIN SCREEN -->
    <div id="screen-join" class="screen hidden">
        <h1>Join Game</h1>
        <p class="subtitle">Enter 5-Digit Code</p>
        <input type="number" id="room-code" placeholder="00000" maxlength="5">
        <p id="error-msg"></p>
        <div class="btn-col">
            <button class="btn-primary" id="btn-connect" onclick="initGame('join')">Launch</button>
            <button class="btn-secondary" onclick="nav('start')">Back</button>
        </div>
    </div>

    <!-- 3. GAME SCREEN -->
    <div id="screen-game" class="screen hidden">
        <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.8rem; color:#666;">
            <span>ROOM: <b id="ui-room" style="color:#fff">----</b></span>
            <span>YOU: <b id="ui-me" style="color:#fff">--</b></span>
        </div>

        <div id="game-area">
            <div id="board"></div> <!-- Grid Cells -->
            <div id="player-layer" class="player-layer"></div> <!-- Tokens float here -->
        </div>

        <div id="hud">
            <div id="turn-info">
                <span id="turn-label">Current Turn</span>
                <span id="turn-player">Waiting...</span>
            </div>
            <div id="dice-box">ðŸŽ²</div>
            <button id="roll-btn" onclick="actionRoll()" disabled>ROLL</button>
        </div>
    </div>

<script>
    /**
     * CONFIGURATION
     */
    const COLORS = ['#00f2ff', '#ff0055', '#ffe600', '#aa00ff']; // Cyan, Pink, Yellow, Purple
    
    // Board Logic (Snakes & Ladders)
    const HOLES = {
        // White Holes (Up)
        4:14, 9:31, 20:38, 28:84, 40:59, 51:67, 63:81, 71:91,
        // Black Holes (Down)
        17:7, 54:34, 62:19, 64:60, 87:24, 93:73, 95:75, 99:78
    };

    /**
     * NETWORK (EMQX Public Broker - SSL 8084)
     */
    const BROKER = "broker.emqx.io";
    const PORT = 8084;
    let client, myId, roomId, isHost = false, myIdx = -1;
    let connected = false;

    /**
     * GAME STATE
     */
    let state = {
        players: [], // { id, pos, color }
        turn: 0,
        dice: 0,
        winner: -1
    };

    /**
     * AUDIO (Tone.js)
     */
    let synth, metal;
    async function startAudio() {
        if (Tone.context.state !== 'running') await Tone.start();
        synth = new Tone.PolySynth().toDestination();
        metal = new Tone.MetalSynth({ harmonicity:5, resonance:4000, envelope:{decay:0.1} }).toDestination();
    }
    const sfx = {
        click: () => synth.triggerAttackRelease("C6", "64n"),
        roll: () => metal.triggerAttackRelease("32n", "16n"),
        step: () => synth.triggerAttackRelease("F5", "32n"),
        good: () => synth.triggerAttackRelease(["C4","E4","G4","C5"], "16n"),
        bad:  () => synth.triggerAttackRelease(["C3","Bb2","Ab2"], "8n"),
        win:  () => metal.triggerAttackRelease("C4", "1n")
    };

    /**
     * NAVIGATION
     */
    function nav(screen) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(`screen-${screen}`).classList.remove('hidden');
        if(screen !== 'game') {
            document.getElementById('room-code').value = '';
            document.getElementById('error-msg').innerText = '';
        }
    }

    /**
     * INIT & CONNECT
     */
    async function initGame(mode) {
        await startAudio();
        sfx.click();

        myId = "p_" + Math.floor(Math.random()*100000);
        
        if(mode === 'create') {
            roomId = Math.floor(10000 + Math.random() * 90000).toString();
            isHost = true;
        } else {
            let val = document.getElementById('room-code').value;
            if(val.length !== 5) {
                document.getElementById('error-msg').innerText = "Code must be 5 digits";
                return;
            }
            roomId = val;
            isHost = false;
        }

        document.getElementById('btn-connect').innerText = "Connecting...";
        
        // Setup MQTT
        client = new Paho.MQTT.Client(BROKER, PORT, myId);
        client.onConnectionLost = (r) => { if(r.errorCode!==0) alert("Connection Lost. Please refresh."); };
        client.onMessageArrived = onMessage;

        client.connect({
            useSSL: true,
            onSuccess: () => {
                connected = true;
                nav('game');
                setupBoard();
                
                document.getElementById('ui-room').innerText = roomId;
                client.subscribe(`bhwh/${roomId}`);

                if(isHost) {
                    // Host adds self immediately
                    state.players.push({ id: myId, pos: 1, color: 0 });
                    myIdx = 0;
                    sync('JOIN');
                } else {
                    // Client requests join
                    send({ type: 'JOIN_REQ', id: myId });
                }
            },
            onFailure: (e) => {
                alert("Connection Failed. Check Internet.");
                document.getElementById('btn-connect').innerText = "Launch";
            }
        });
    }

    /**
     * NETWORK LOGIC
     */
    function send(data) {
        if(!connected) return;
        let msg = new Paho.MQTT.Message(JSON.stringify(data));
        msg.destinationName = `bhwh/${roomId}`;
        client.send(msg);
    }

    function sync(evt) {
        send({ type: 'STATE', state: state, evt: evt });
        render(); // Host renders immediately
    }

    function onMessage(m) {
        let data = JSON.parse(m.payloadString);
        if(data.sender === myId) return;

        // Host Logic
        if(isHost) {
            if(data.type === 'JOIN_REQ') {
                if(state.players.length < 4) {
                    let exists = state.players.find(p => p.id === data.id);
                    if(!exists) {
                        state.players.push({ id: data.id, pos: 1, color: state.players.length });
                        sync('JOIN');
                    } else {
                        sync(null); // Just refresh them
                    }
                }
            }
            if(data.type === 'ROLL_REQ') {
                // Verify turn
                let p = state.players.findIndex(pl => pl.id === data.id);
                if(p === state.turn && state.winner === -1) {
                    runTurn();
                }
            }
        }

        // Client Logic
        if(data.type === 'STATE') {
            state = data.state;
            if(myIdx === -1) myIdx = state.players.findIndex(p => p.id === myId);
            
            // Sounds
            if(data.evt === 'JOIN') sfx.click();
            if(data.evt === 'ROLL') sfx.roll();
            if(data.evt === 'STEP') sfx.step();
            if(data.evt === 'GOOD') sfx.good();
            if(data.evt === 'BAD') sfx.bad();
            if(data.evt === 'WIN') sfx.win();

            render();
        }
    }

    /**
     * GAME LOGIC (HOST ONLY)
     */
    function actionRoll() {
        if(isHost) {
            if(state.turn === 0 && state.winner === -1) runTurn();
        } else {
            send({ type: 'ROLL_REQ', id: myId });
        }
    }

    function runTurn() {
        // 1. Roll
        let roll = Math.floor(Math.random() * 6) + 1;
        state.dice = roll;
        sync('ROLL');

        // 2. Move (Delay)
        setTimeout(() => {
            let p = state.players[state.turn];
            let next = p.pos + roll;
            if(next > 100) next = p.pos; // Bounce if over
            p.pos = next;
            
            if(next === 100) {
                state.winner = state.turn;
                sync('WIN');
            } else if(HOLES[next]) {
                sync('STEP');
                setTimeout(() => {
                    let dest = HOLES[next];
                    let evt = dest > next ? 'GOOD' : 'BAD';
                    p.pos = dest;
                    sync(evt);
                    nextTurn();
                }, 800);
            } else {
                sync('STEP');
                nextTurn();
            }
        }, 600);
    }

    function nextTurn() {
        setTimeout(() => {
            state.turn = (state.turn + 1) % state.players.length;
            sync(null);
        }, 500);
    }

    /**
     * RENDERING
     */
    function setupBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        
        // Create 100 Cells
        for(let i=100; i>=1; i--) {
            let cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.id = i;
            cell.innerText = i;
            
            // Visuals
            if(HOLES[i]) {
                let v = document.createElement('div');
                v.className = HOLES[i] > i ? 'wh-visual' : 'bh-visual';
                cell.appendChild(v);
            }
            board.appendChild(cell);
        }
    }

    function render() {
        // UI Text
        document.getElementById('ui-me').innerText = myIdx > -1 ? `P${myIdx+1}` : '--';
        document.getElementById('ui-me').style.color = myIdx > -1 ? COLORS[myIdx] : '#fff';
        document.getElementById('dice-box').innerText = state.dice || "ðŸŽ²";

        let turnP = state.players[state.turn];
        let info = document.getElementById('turn-player');
        
        if(state.winner > -1) {
            info.innerText = `P${state.winner+1} WINS!`;
            info.style.color = COLORS[state.winner];
        } else if(state.players.length < 2) {
            info.innerText = "Waiting for P2...";
            info.style.color = "#888";
        } else {
            info.innerText = `Player ${state.turn+1}`;
            info.style.color = COLORS[state.turn];
        }

        // Button State
        let btn = document.getElementById('roll-btn');
        let myTurn = (myIdx === state.turn && state.winner === -1 && state.players.length > 1);
        btn.disabled = !myTurn;
        btn.style.background = myTurn ? COLORS[myIdx] : '#333';

        // RENDER TOKENS
        const layer = document.getElementById('player-layer');
        layer.innerHTML = '';

        // Group players by position to handle overlap
        let map = {}; 
        state.players.forEach((p, i) => {
            if(!map[p.pos]) map[p.pos] = [];
            map[p.pos].push(i);
        });

        state.players.forEach((p, i) => {
            let t = document.createElement('div');
            t.className = 'token';
            if(i === state.turn) t.classList.add('active');
            t.style.color = COLORS[p.color];
            
            let coords = getCoords(p.pos);
            
            // Overlap Logic (Slot System)
            // If multiple people on tile, offset them into 2x2 grid inside the tile
            // Slots: 0:TopLeft, 1:TopRight, 2:BottomLeft, 3:BottomRight
            let siblings = map[p.pos];
            if(siblings.length > 1) {
                let idxInCell = siblings.indexOf(i);
                // Base center is 50% of cell. Token is approx 40% of cell width.
                // We need to shift +/- 25% of the CELL size.
                // Cell is 10% of board. So shift +/- 2.5% of board.
                let shiftX = (idxInCell % 2 === 0) ? -2 : 2; 
                let shiftY = (idxInCell < 2) ? 2 : -2; // CSS Bottom grows up
                
                // Adjust coords
                // "bottom" % + half cell (5%) + shift
                // "left" % + half cell (5%) + shift
                // Minus half token size (1.75%)
                t.style.bottom = `calc(${coords.r * 10}% + 5% + ${shiftY}% - 1.75%)`;
                t.style.left = `calc(${coords.c * 10}% + 5% + ${shiftX}% - 1.75%)`;
            } else {
                // Perfectly centered
                t.style.bottom = `calc(${coords.r * 10}% + 5% - 1.75%)`;
                t.style.left = `calc(${coords.c * 10}% + 5% - 1.75%)`;
            }

            layer.appendChild(t);
        });
    }

    function getCoords(n) {
        // n is 1 to 100
        let r = Math.floor((n - 1) / 10); // 0 to 9
        let c = (n - 1) % 10; // 0 to 9
        if (r % 2 === 1) c = 9 - c; // ZigZag
        return { r, c };
    }

</script>
</body>
</html>
